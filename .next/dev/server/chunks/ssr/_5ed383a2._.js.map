{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/haradataishi/Culcept/lib/supabaseAdmin.ts"],"sourcesContent":["import \"server-only\";\nimport { createClient } from \"@supabase/supabase-js\";\n\nfunction mustGetEnv(name: string, value: string | undefined) {\n    const v = (value ?? \"\").trim();\n    if (!v) {\n        throw new Error(\n            `[supabaseAdmin] Missing env: ${name}. ` +\n            `Set SUPABASE_URL (or NEXT_PUBLIC_SUPABASE_URL) and SUPABASE_SERVICE_ROLE_KEY in .env.local`\n        );\n    }\n    return v;\n}\n\n// URL は NEXT_PUBLIC_* を優先しつつ、なければ SUPABASE_URL も見る\nconst url = process.env.NEXT_PUBLIC_SUPABASE_URL ?? process.env.SUPABASE_URL;\n\n// Service Role は絶対にクライアントへ渡さない（server-only で守る）\nconst serviceKey =\n    process.env.SUPABASE_SERVICE_ROLE_KEY ?? process.env.SUPABASE_SERVICE_KEY;\n\nexport const supabaseAdmin = createClient(\n    mustGetEnv(\"SUPABASE_URL / NEXT_PUBLIC_SUPABASE_URL\", url),\n    mustGetEnv(\"SUPABASE_SERVICE_ROLE_KEY\", serviceKey),\n    {\n        auth: { persistSession: false, autoRefreshToken: false },\n    }\n);\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEA,SAAS,WAAW,IAAY,EAAE,KAAyB;IACvD,MAAM,IAAI,CAAC,SAAS,EAAE,EAAE,IAAI;IAC5B,IAAI,CAAC,GAAG;QACJ,MAAM,IAAI,MACN,CAAC,6BAA6B,EAAE,KAAK,EAAE,CAAC,GACxC,CAAC,0FAA0F,CAAC;IAEpG;IACA,OAAO;AACX;AAEA,mDAAmD;AACnD,MAAM,MAAM,gFAAwC,QAAQ,GAAG,CAAC,YAAY;AAE5E,gDAAgD;AAChD,MAAM,aACF,QAAQ,GAAG,CAAC,yBAAyB,IAAI,QAAQ,GAAG,CAAC,oBAAoB;AAEtE,MAAM,gBAAgB,IAAA,8LAAY,EACrC,WAAW,2CAA2C,MACtD,WAAW,6BAA6B,aACxC;IACI,MAAM;QAAE,gBAAgB;QAAO,kBAAkB;IAAM;AAC3D"}},
    {"offset": {"line": 33, "column": 0}, "map": {"version":3,"sources":["file:///Users/haradataishi/Culcept/app/drops/new/actions.ts"],"sourcesContent":["\"use server\";\n\nimport { redirect } from \"next/navigation\";\nimport { revalidatePath } from \"next/cache\";\nimport { supabaseServer } from \"@/lib/supabase/server\";\nimport { supabaseAdmin } from \"@/lib/supabaseAdmin\";\nimport type { DropActionState } from \"./type\";\n\nconst BUCKET = \"drops\";\n\nfunction s(v: FormDataEntryValue | null) {\n    return typeof v === \"string\" ? v.trim() : \"\";\n}\n\nfunction normalizeUrl(raw: string) {\n    const x = raw.trim();\n    if (!x) return \"\";\n    try {\n        new URL(x);\n        return x;\n    } catch {\n        try {\n            new URL(\"https://\" + x);\n            return \"https://\" + x;\n        } catch {\n            return \"\";\n        }\n    }\n}\n\nfunction parseTags(json: string): string[] {\n    if (!json) return [];\n    try {\n        const v = JSON.parse(json);\n        if (!Array.isArray(v)) return [];\n        return v\n            .map((x) => String(x ?? \"\").trim().toLowerCase())\n            .filter(Boolean)\n            .slice(0, 20);\n    } catch {\n        return [];\n    }\n}\n\nfunction isColumnMissingError(err: any) {\n    const code = String(err?.code ?? \"\");\n    const msg = String(err?.message ?? \"\");\n    return code === \"42703\" || (msg.includes(\"column\") && msg.includes(\"does not exist\"));\n}\n\nasync function uploadImages(dropId: string, userId: string, files: File[]) {\n    const uploaded: { sort: number; public_url: string; path: string }[] = [];\n\n    for (let i = 0; i < files.length; i++) {\n        const f = files[i];\n        if (!f || f.size === 0) continue;\n        if (!String(f.type || \"\").startsWith(\"image/\")) continue;\n\n        const ext = (f.name.split(\".\").pop() || \"jpg\").toLowerCase();\n        const safeExt = ext.length <= 6 ? ext : \"jpg\";\n        const path = `${dropId}/${crypto.randomUUID()}.${safeExt}`;\n\n        const buf = Buffer.from(await f.arrayBuffer());\n        const { error: upErr } = await supabaseAdmin.storage.from(BUCKET).upload(path, buf, {\n            contentType: f.type || \"image/jpeg\",\n            upsert: false,\n        });\n        if (upErr) throw upErr;\n\n        const pub = supabaseAdmin.storage.from(BUCKET).getPublicUrl(path);\n        const public_url = pub.data.publicUrl;\n\n        uploaded.push({ sort: i, public_url, path });\n    }\n\n    if (uploaded.length > 0) {\n        // drop_images insert（path/user_id 列が無いDBでも落ちない）\n        const rowsFull = uploaded.map((x) => ({\n            drop_id: dropId,\n            user_id: userId,\n            sort: x.sort,\n            public_url: x.public_url,\n            path: x.path,\n        }));\n\n        const { error: insErr1 } = await supabaseAdmin.from(\"drop_images\").insert(rowsFull as any);\n\n        if (insErr1) {\n            if (isColumnMissingError(insErr1)) {\n                // まず path 抜き\n                const rowsNoPath = uploaded.map((x) => ({\n                    drop_id: dropId,\n                    user_id: userId,\n                    sort: x.sort,\n                    public_url: x.public_url,\n                }));\n                const { error: insErr2 } = await supabaseAdmin.from(\"drop_images\").insert(rowsNoPath as any);\n\n                if (insErr2 && isColumnMissingError(insErr2)) {\n                    // user_id も無い場合\n                    const rowsMin = uploaded.map((x) => ({\n                        drop_id: dropId,\n                        sort: x.sort,\n                        public_url: x.public_url,\n                    }));\n                    const { error: insErr3 } = await supabaseAdmin.from(\"drop_images\").insert(rowsMin as any);\n                    if (insErr3) throw insErr3;\n                } else if (insErr2) {\n                    throw insErr2;\n                }\n            } else {\n                throw insErr1;\n            }\n        }\n\n        // cover\n        const cover = uploaded[0]?.public_url ?? null;\n        if (cover) {\n            const { error: updErr } = await supabaseAdmin.from(\"drops\").update({ cover_image_url: cover }).eq(\"id\", dropId);\n            if (updErr && !isColumnMissingError(updErr)) throw updErr;\n        }\n    }\n\n    return uploaded;\n}\n\nexport async function createDropAction(\n    _prev: DropActionState,\n    formData: FormData\n): Promise<DropActionState> {\n    const supabase = await supabaseServer();\n    const { data: auth } = await supabase.auth.getUser();\n    const user = auth.user;\n\n    if (!user) return { ok: false, error: \"ログインしてください。\" };\n\n    const title = s(formData.get(\"title\"));\n    const brand = s(formData.get(\"brand\"));\n    const size = s(formData.get(\"size\"));\n    const condition = s(formData.get(\"condition\"));\n    const priceRaw = s(formData.get(\"price\"));\n    const urlRaw = s(formData.get(\"url\"));\n    const purchaseRaw = s(formData.get(\"purchase_url\"));\n    const description = s(formData.get(\"description\"));\n    const tagsJson = s(formData.get(\"tags\"));\n\n    const fieldErrors: Record<string, string> = {};\n\n    if (!title || title.length < 2) fieldErrors.title = \"Title は2文字以上を推奨。\";\n\n    let price: number | null = null;\n    if (priceRaw) {\n        const n = Number(priceRaw);\n        if (!Number.isFinite(n) || n < 0) fieldErrors.price = \"Price は0以上の数字にして。\";\n        else price = Math.floor(n);\n    }\n\n    const url = urlRaw ? normalizeUrl(urlRaw) : \"\";\n    if (urlRaw && !url) fieldErrors.url = \"URL形式が不正。https:// を含めて。\";\n\n    const purchase_url = purchaseRaw ? normalizeUrl(purchaseRaw) : \"\";\n    if (purchaseRaw && !purchase_url) fieldErrors.purchase_url = \"URL形式が不正。https:// を含めて。\";\n\n    const tags = parseTags(tagsJson);\n\n    if (Object.keys(fieldErrors).length > 0) return { ok: false, error: \"入力を確認して。\", fieldErrors };\n\n    // insert drop\n    const { data: inserted, error: insErr } = await supabaseAdmin\n        .from(\"drops\")\n        .insert({\n            user_id: user.id,\n            title,\n            brand: brand || null,\n            size: size || null,\n            condition: condition || null,\n            price,\n            url: url || null,\n            purchase_url: purchase_url || null,\n            description: description || null,\n            tags: tags.length ? tags : null,\n        } as any)\n        .select(\"id\")\n        .single();\n\n    if (insErr || !inserted?.id) return { ok: false, error: insErr?.message ?? \"作成に失敗した。\" };\n\n    const dropId = inserted.id as string;\n\n    // images (optional)\n    const files = formData.getAll(\"images\").filter((x): x is File => x instanceof File);\n    const limited = files.slice(0, 12);\n\n    try {\n        if (limited.length > 0) {\n            await uploadImages(dropId, user.id, limited);\n        }\n    } catch (e: any) {\n        return { ok: false, error: `画像アップロードに失敗: ${e?.message ?? \"unknown\"}` };\n    }\n\n    revalidatePath(\"/drops\");\n    revalidatePath(`/drops/${dropId}`);\n\n    redirect(`/drops/${dropId}`);\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 232, "column": 0}, "map": {"version":3,"sources":["file:///Users/haradataishi/Culcept/.next-internal/server/app/drops/new/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {logoutAction as '003af1db1e1d56e96cd9bb4adb8bb8da6a5bf2b974'} from 'ACTIONS_MODULE0'\nexport {authAction as '60faef4636f589674be7bd964e90055fe8ec65938f'} from 'ACTIONS_MODULE0'\nexport {createDropAction as '60657f279b9abaabac4f96307a0d5844e5350d951c'} from 'ACTIONS_MODULE1'\n"],"names":[],"mappings":";AAAA;AAEA"}}]
}